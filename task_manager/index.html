<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Modeling Service Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg-body: #121212;
            --bg-panel: #1e1e1e;
            --bg-header: #252526;
            --text-main: #e0e0e0;
            --text-muted: #858585;
            --border-color: #333333;
            --input-bg: #2d2d2d;
            
            --accent-primary: #0078d4;
            --accent-hover: #006cc1;
            --accent-green: #107c10;
            --accent-red: #e81123;
            --accent-orange: #d83b01;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg-body); 
            color: var(--text-main);
            margin: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
        }
        
        /* HEADER */
        header { 
            background: var(--bg-header); 
            padding: 0 20px; 
            height: 50px;
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
        }
        h2 { margin: 0; font-size: 1rem; font-weight: 600; letter-spacing: 0.5px; }
        
        .layout { display: flex; flex: 1; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { 
            width: 320px; 
            background: var(--bg-panel); 
            border-right: 1px solid var(--border-color); 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            gap: 20px; 
            overflow-y: auto; 
            box-sizing: border-box;
        }
        
        /* FORM ELEMENTS */
        label { 
            font-size: 0.8rem; 
            color: var(--text-muted); 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600;
        }
        
        input, select { 
            width: 100%; 
            padding: 10px; 
            background: var(--input-bg); 
            border: 1px solid var(--border-color); 
            color: var(--text-main); 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-family: inherit;
        }
        input:focus, select:focus {
            outline: 1px solid var(--accent-primary);
            border-color: var(--accent-primary);
        }

        /* TABS */
        .tabs { 
            display: flex; 
            background: var(--input-bg); 
            border-radius: 4px; 
            padding: 2px; 
        }
        .tab { 
            flex: 1; 
            text-align: center; 
            padding: 8px; 
            cursor: pointer; 
            border-radius: 2px; 
            font-size: 0.85rem;
            color: var(--text-muted);
            transition: 0.2s;
        }
        .tab.active { 
            background: var(--bg-panel); 
            color: var(--text-main); 
            font-weight: 600;
        }
        
        /* MANUAL TABLE */
        .manual-wrapper { 
            border: 1px solid var(--border-color); 
            max-height: 200px; 
            overflow-y: auto; 
            background: var(--input-bg);
            margin-bottom: 10px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        th { 
            position: sticky; 
            top: 0; 
            background: #333; 
            padding: 5px; 
            text-align: center; 
            color: var(--text-muted);
        }
        td { border-bottom: 1px solid var(--border-color); }
        td input { 
            border: none; 
            background: transparent; 
            text-align: center; 
            padding: 5px;
            border-radius: 0;
        }
        td input:focus { background: #444; }

        /* BUTTONS */
        .btn { 
            width: 100%; 
            padding: 10px; 
            border: none; 
            border-radius: 4px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: 0.2s; 
            font-size: 0.9rem; 
        }
        .btn-primary { background: var(--accent-primary); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        
        .btn-secondary { 
            background: transparent; 
            border: 1px solid var(--border-color); 
            color: var(--text-muted); 
            padding: 8px;
            font-size: 0.8rem;
        }
        .btn-secondary:hover { color: var(--text-main); border-color: var(--text-muted); }

        /* CONTENT GRID */
        .content { 
            flex: 1; 
            padding: 25px; 
            overflow-y: auto; 
            background: var(--bg-body); 
        }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; 
        }
        
        /* CARDS */
        .card { 
            background: var(--bg-panel); 
            padding: 15px; 
            border-radius: 6px; 
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            min-height: 150px;
            transition: 0.2s;
            position: relative;
        }
        .card:hover { 
            border-color: #555; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
        }
        
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
        }
        .card-title { font-weight: 600; font-size: 1rem; color: var(--text-main); }
        .card-id { font-family: monospace; color: var(--text-muted); font-size: 0.8em; margin-bottom: 15px; }
        
        .delete-btn { 
            background: transparent; 
            border: none; 
            color: var(--text-muted); 
            font-size: 1.2rem; 
            cursor: pointer; 
            line-height: 1;
            padding: 0 5px;
        }
        .delete-btn:hover { color: var(--accent-red); }

        /* STATUS BADGES */
        .badge { 
            padding: 3px 8px; 
            border-radius: 3px; 
            font-size: 0.7em; 
            font-weight: 700; 
            text-transform: uppercase; 
        }
        .status-pending { color: var(--accent-orange); border: 1px solid var(--accent-orange); }
        .status-working { color: var(--accent-primary); border: 1px solid var(--accent-primary); }
        .status-done { color: var(--accent-green); border: 1px solid var(--accent-green); }
        .status-error { color: var(--accent-red); border: 1px solid var(--accent-red); }

        .view-btn { 
            margin-top: auto; /* Pushes button to bottom */
            width: 100%; 
            padding: 8px; 
            background: var(--input-bg); 
            border: 1px solid var(--border-color); 
            color: var(--text-main); 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.85rem;
        }
        .view-btn:hover { background: #3a3a3a; }

        /* MODAL */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); 
            z-index: 1000; 
            justify-content: center; 
            align-items: center; 
            backdrop-filter: blur(2px);
        }
        .modal.active { display: flex; }
        .modal-content { 
            background: var(--bg-panel); 
            width: 90%; 
            max-width: 900px; 
            height: 80vh; 
            border-radius: 8px; 
            border: 1px solid var(--border-color);
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .modal-header { 
            padding: 15px; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: var(--bg-header);
        }
        .modal-body { 
            flex: 1; 
            display: flex; 
            overflow: hidden; 
        }
        .col-left { 
            flex: 1; 
            border-right: 1px solid var(--border-color); 
            padding: 20px; 
            overflow-y: auto; 
        }
        .col-right { 
            flex: 2; 
            padding: 20px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }

        .data-list { list-style: none; padding: 0; margin: 0; font-family: monospace; font-size: 0.9em; color: var(--text-muted); }
        .data-list li { 
            border-bottom: 1px solid var(--border-color); 
            padding: 6px 0; 
            display: flex; 
            justify-content: space-between; 
        }
        
        #resultImg { 
            max-width: 100%; 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            margin-top: 10px;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>

<header>
    <h2>Modeling Service</h2>
    <div style="font-size: 0.8rem; color: var(--text-muted);">v1.0.0</div>
</header>

<div class="layout">
    
    <div class="sidebar">
        
        <div>
            <label>Task Type</label>
            <select id="taskType">
                <option value="tsp">TSP - Genetic Algorithm</option>
                <option value="none" disabled>Future Module...</option>
            </select>
        </div>

        <div>
            <label>Input Mode</label>
            <div class="tabs">
                <div class="tab active" onclick="setMode('auto')" id="tab-auto">Auto</div>
                <div class="tab" onclick="setMode('manual')" id="tab-manual">Manual</div>
            </div>
        </div>

        <div>
            <label>City Count</label>
            <input type="number" id="citiesCount" value="20" min="2" max="100" onchange="if(currentMode==='manual') renderManualTable()">
        </div>

        <div id="panel-auto" style="padding: 10px; background: rgba(255,255,255,0.03); border-radius: 4px; font-size: 0.85rem; color: var(--text-muted);">
            Coordinates generated randomly on server.
        </div>

        <div id="panel-manual" style="display:none;">
            <label>Coordinates (0-100)</label>
            <div class="manual-wrapper">
                <table id="manualTable">
                    </table>
            </div>
            <button class="btn btn-secondary" onclick="renderManualTable()">Clear Table</button>
        </div>

        <div style="margin-top: auto;">
            <div id="createStatus" style="text-align: center; margin-bottom: 10px; font-size: 0.8rem; min-height: 1.2rem;"></div>
            <button class="btn btn-primary" onclick="createTask()">Create Task</button>
        </div>
    </div>

    <div class="content">
        <div id="grid" class="grid">
            </div>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0">Task Details</h3>
            <span onclick="closeModal()" style="font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</span>
        </div>
        <div class="modal-body">
            <div class="col-left">
                <label>Input Data</label>
                <ul id="mInputList" class="data-list"></ul>
            </div>
            <div class="col-right">
                <label>Result</label>
                <div id="mResultContent" style="width: 100%; text-align: center; margin-top: 10px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // AUTOMATIC API URL DETECTION
    const BASE_URL = window.location.origin; 
    const API = `${BASE_URL}/api`;
    
    let currentMode = 'auto';

    document.addEventListener("DOMContentLoaded", () => {
        refresh();
        setInterval(refresh, 3000); 
    });

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('tab-auto').className = mode === 'auto' ? 'tab active' : 'tab';
        document.getElementById('tab-manual').className = mode === 'manual' ? 'tab active' : 'tab';
        document.getElementById('panel-auto').style.display = mode === 'auto' ? 'block' : 'none';
        document.getElementById('panel-manual').style.display = mode === 'manual' ? 'block' : 'none';
        
        if(mode === 'manual') renderManualTable();
    }

    function renderManualTable() {
        const count = parseInt(document.getElementById('citiesCount').value) || 5;
        const tbody = document.getElementById('manualTable');
        tbody.innerHTML = `<thead><tr><th>#</th><th>X</th><th>Y</th></tr></thead><tbody>`;
        
        let rows = '';
        for(let i=0; i<count; i++) {
            rows += `<tr>
                <td>${i+1}</td>
                <td><input type="number" class="mx" value="${Math.floor(Math.random()*100)}"></td>
                <td><input type="number" class="my" value="${Math.floor(Math.random()*100)}"></td>
            </tr>`;
        }
        tbody.innerHTML += rows + '</tbody>';
    }

    async function createTask() {
        const status = document.getElementById('createStatus');
        const count = parseInt(document.getElementById('citiesCount').value);
        const typeSelect = document.getElementById('taskType').value;
        
        status.style.color = "var(--text-muted)";
        status.innerText = "Sending...";

        let payload = {
            cities_count: count,
            generate_random: (currentMode === 'auto')
        };

        if (currentMode === 'manual') {
            const xs = document.querySelectorAll('.mx');
            const ys = document.querySelectorAll('.my');
            let coords = [];
            xs.forEach((xInput, i) => {
                coords.push({
                    x: parseFloat(xInput.value) || 0,
                    y: parseFloat(ys[i].value) || 0
                });
            });
            payload.coordinates = coords;
        }

        try {
            await fetch(`${API}/create`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({type: typeSelect, data: payload})
            });
            status.style.color = "var(--accent-green)";
            status.innerText = "Task Created";
            refresh();
            setTimeout(() => status.innerText = "", 2000);
        } catch (e) {
            status.style.color = "var(--accent-red)";
            status.innerText = "Server Error";
        }
    }

    async function deleteTask(e, id) {
        e.stopPropagation();
        if(!confirm("Delete this task?")) return;
        
        try {
            await fetch(`${API}/delete/${id}`, { method: 'DELETE' });
            refresh();
        } catch(e) { alert("Delete failed"); }
    }

    async function refresh() {
        try {
            const res = await fetch(`${API}/history`);
            const tasks = await res.json();
            renderGrid(tasks);
        } catch (e) {}
    }

    function renderGrid(tasks) {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        
        const map = {
            0: {txt: "Pending", cls: "status-pending"},
            1: {txt: "Working", cls: "status-working"},
            2: {txt: "Done", cls: "status-done"},
            3: {txt: "Error", cls: "status-error"}
        };

        tasks.forEach(t => {
            const st = map[t.status] || map[0];
            const div = document.createElement('div');
            div.className = `card`;
            div.onclick = () => openModal(t.id);
            div.innerHTML = `
                <div class="card-header">
                    <span class="badge ${st.cls}">${st.txt}</span>
                    <button class="delete-btn" onclick="deleteTask(event, '${t.id}')">&times;</button>
                </div>
                <div class="card-title">${t.type.toUpperCase()}</div>
                <div class="card-id">ID: ...${t.id.slice(-8)}</div>
                <button class="view-btn">View Result</button>
            `;
            grid.appendChild(div);
        });
    }

    async function openModal(id) {
        document.getElementById('modal').classList.add('active');
        const inputList = document.getElementById('mInputList');
        const resBox = document.getElementById('mResultContent');
        
        inputList.innerHTML = "<li>Loading data...</li>";
        resBox.innerHTML = "";

        try {
            const res = await fetch(`${API}/result/${id}`);
            const data = await res.json();
            
            // INPUTS
            inputList.innerHTML = "";
            let inputs = (data.input_data && data.input_data.coordinates) ? data.input_data.coordinates : [];
            
            if (inputs.length === 0 && data.input_data.cities_count) {
               inputList.innerHTML = `<li>Auto-generated: ${data.input_data.cities_count} cities</li>`;
            } else {
                inputs.forEach((pt, i) => {
                    inputList.innerHTML += `<li><span>Point ${i+1}</span> <span>[${pt.x}, ${pt.y}]</span></li>`;
                });
            }

            // RESULTS
            if (data.status === 2 && data.result) {
                const dist = parseFloat(data.result.shortest_distance).toFixed(2);
                let html = `<div style="font-size:1.4rem; margin-bottom:15px; color:var(--accent-green); font-weight:bold;">Distance: ${dist}</div>`;
                if(data.result.best_root_graph) {
                    html += `<img id="resultImg" src="data:image/png;base64,${data.result.best_root_graph}" />`;
                }
                resBox.innerHTML = html;
            } else if (data.status === 3) {
                resBox.innerHTML = `<div style="color:var(--accent-red)">Error: ${JSON.stringify(data.result)}</div>`;
            } else {
                resBox.innerHTML = `<div style="color:var(--accent-primary)">Processing...</div>`;
            }

        } catch(e) {
            resBox.innerText = "Error loading details";
        }
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('active');
    }
</script>

</body>
</html>
