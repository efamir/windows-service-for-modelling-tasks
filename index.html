<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ—Ä–≤—ñ—Å –º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è | –¢–í-33</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --light: #ecf0f1;
            --warning: #f39c12;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; color: #333; margin: 0; padding: 0; }
        
        /* HEADER */
        header { background-color: var(--primary); color: white; padding: 1rem 0; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.5rem; }
        
        /* CONTAINER & SECTIONS */
        .container { max-width: 900px; margin: 30px auto; padding: 0 20px; }
        .screen { display: none; animation: fadeIn 0.4s; }
        .screen.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS */
        .card { background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 30px; margin-bottom: 20px; }
        .center-text { text-align: center; }

        /* HERO TEXT */
        .hero-title { font-size: 2.2rem; color: var(--primary); margin-bottom: 10px; }
        .hero-subtitle { font-size: 1.1rem; color: #7f8c8d; margin-bottom: 30px; }
        .team-list { list-style: none; padding: 0; font-size: 1.1rem; line-height: 1.6; color: #2c3e50; margin: 20px auto; display: inline-block; text-align: left; }
        .team-list li { border-bottom: 1px solid #eee; padding: 8px 15px; }

        /* BUTTONS */
        .btn { padding: 10px 20px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; font-size: 1rem; transition: 0.2s; margin: 5px; }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-primary:hover { background-color: #2980b9; transform: translateY(-1px); }
        .btn-success { background-color: var(--success); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: white; }
        .btn-mode { flex: 1; border-radius: 0; margin: 0; background: #eee; color: #7f8c8d; }
        .btn-mode.active { background: var(--accent); color: white; }

        /* TABS */
        .mode-switcher { display: flex; border-radius: 6px; overflow: hidden; margin-bottom: 20px; border: 1px solid #ddd; }

        /* MATRIX & INPUTS */
        .matrix-wrapper { overflow-x: auto; margin: 20px 0; display: flex; justify-content: center; }
        table { border-collapse: collapse; }
        td, th { padding: 5px; }
        input.matrix-input { width: 50px; text-align: center; border: 1px solid #bdc3c7; padding: 8px; border-radius: 4px; }
        input.matrix-input:focus { border-color: var(--accent); outline: none; }
        input.matrix-input[disabled] { background-color: #f0f3f4; }
        
        .input-group { margin: 15px 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .input-number { padding: 8px; width: 70px; border: 1px solid #ccc; border-radius: 4px; }

        /* STATUS & VISUALIZATION */
        #status-box { margin: 20px auto; padding: 15px; border-radius: 4px; max-width: 600px; font-weight: bold; display: none; text-align: center; }
        .status-processing { background-color: var(--accent); color: white; }
        .status-done { background-color: var(--success); color: white; }
        .status-error { background-color: #e74c3c; color: white; }
        
        #canvas-container { margin-top: 30px; display: flex; justify-content: center; }
        canvas { border: 1px solid #ddd; background: #fafafa; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .footer { text-align: center; margin-top: 50px; color: #95a5a6; font-size: 0.9rem; }
    </style>
</head>
<body>

<header>
    <div class="container">
        <h1>–°–µ—Ä–≤—ñ—Å –¥–ª—è –∑–∞–¥–∞—á –º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è</h1>
    </div>
</header>

<div class="container">
    
    <div id="screen-home" class="screen active">
        <div class="card center-text">
            <h2 class="hero-title">–í—ñ—Ç–∞—î–º–æ!</h2>
            <p class="hero-subtitle">–ü—Ä–æ–µ–∫—Ç–Ω–∞ —Ä–æ–±–æ—Ç–∞ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –≥—Ä—É–ø–∏ <strong>–¢–í-33</strong></p>
            
            <div style="background: #fdfdfd; display: inline-block; padding: 10px 40px; border-radius: 10px; border: 1px solid #eee;">
                <h3>–ö–æ–º–∞–Ω–¥–∞ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫—ñ–≤:</h3>
                <ul class="team-list">
                    <li>üë§ –ö–æ–∑—ñ–Ω—á–µ–Ω–∫–æ –¢–∏–º–æ—Ñ—ñ–π</li>
                    <li>üë§ –õ–µ–≤—É–Ω –¢–∏–º–æ—Ñ—ñ–π</li>
                    <li>üë§ –ì–æ–ª–¥–æ–≤—Å—å–∫–∏–π –û–ª–µ–∫—Å–∞–Ω–¥—Ä</li>
                    <li>üë§ –ß–µ—Ä–Ω—è–≤—Å—å–∫–∏–π –ú–∞–∫—Å–∏–º</li>
                </ul>
            </div>

            <div style="margin-top: 40px;">
                <button class="btn btn-primary" onclick="showScreen('screen-select')">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –∑–∞–¥–∞—á</button>
            </div>
        </div>
    </div>

    <div id="screen-select" class="screen">
        <div class="card center-text">
            <h2>–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –∑–∞–¥–∞—á—ñ</h2>
            <p>–î–æ—Å—Ç—É–ø–Ω—ñ –º–∞—Ç–µ–º–∞—Ç–∏—á–Ω—ñ –º–æ–¥–µ–ª—ñ:</p>
            
            <div id="task-buttons-container" style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∏–ø—ñ–≤...</p>
            </div>

            <div style="margin-top: 30px;">
                <button class="btn btn-outline" onclick="showScreen('screen-home')">‚¨Ö –ù–∞–∑–∞–¥</button>
            </div>
        </div>
    </div>

    <div id="screen-tsp" class="screen">
        <div class="card">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button class="btn btn-outline" style="padding: 5px 10px; font-size: 0.8rem;" onclick="showScreen('screen-select')">‚¨Ö –ú–µ–Ω—é</button>
                <h2 style="margin:0;">–ó–∞–¥–∞—á–∞ –ö–æ–º—ñ–≤–æ—è–∂–µ—Ä–∞</h2>
                <div style="width: 60px;"></div>
            </div>
            
            <div class="input-group">
                <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –º—ñ—Å—Ç (N):</label>
                <input type="number" id="citiesCount" class="input-number" value="5" min="2" max="20" onchange="if(currentMode==='manual') generateMatrixInputs()">
            </div>

            <div class="mode-switcher">
                <button class="btn btn-mode active" id="mode-auto" onclick="setMode('auto')">üé≤ –ê–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü—ñ—è (–°–µ—Ä–≤–µ—Ä)</button>
                <button class="btn btn-mode" id="mode-manual" onclick="setMode('manual')">‚úçÔ∏è –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É</button>
            </div>

            <div id="manual-container" style="display:none;">
                <p class="center-text" style="font-size: 0.9em; color: #777;">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –º–∞—Ç—Ä–∏—Ü—é –≤—ñ–¥—Å—Ç–∞–Ω–µ–π –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–í–∏–ø–∞–¥–∫–æ–≤—ñ –¥–∞–Ω—ñ" –¥–ª—è —Ç–µ—Å—Ç—É –∫–ª—ñ—î–Ω—Ç–∞.</p>
                <div class="center-text">
                    <button class="btn btn-outline" style="font-size: 0.8rem;" onclick="fillClientRandomMatrix()">–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –≤–∏–ø–∞–¥–∫–æ–≤–æ (–ö–ª—ñ—î–Ω—Ç)</button>
                </div>
                <div class="matrix-wrapper">
                    <table id="matrixTable"></table>
                </div>
            </div>

            <div id="auto-container" class="center-text">
                <p>–°–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–≥–µ–Ω–µ—Ä—É—î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –º—ñ—Å—Ç —Ç–∞ —Ä–æ–∑—Ä–∞—Ö—É—î –≤—ñ–¥—Å—Ç–∞–Ω—ñ.</p>
                <p style="color: #27ae60; font-weight: bold;">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏", —â–æ–± —Ä–æ–∑–ø–æ—á–∞—Ç–∏.</p>
            </div>

            <div class="center-text" style="margin-top: 20px;">
                <button class="btn btn-success" id="solveBtn" onclick="startTask()">üöÄ –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç</button>
            </div>
            
            <div id="status-box"></div>
            <div id="result-text" class="center-text" style="margin-top: 15px; font-size: 1.1em;"></div>

            <div id="canvas-container">
                <canvas id="visualizer" width="600" height="400" style="display:none;"></canvas>
            </div>
        </div>
    </div>

</div>

<div class="footer">
    &copy; 2025 –ì—Ä—É–ø–∞ –¢–í-33. –ü—Ä–æ–µ–∫—Ç–Ω–∞ —Ä–æ–±–æ—Ç–∞.
</div>

<script>
    const API_BASE = "http://localhost:8000"; 
    const WS_BASE = "ws://localhost:8000";

    let currentMode = 'auto'; // 'auto' or 'manual'

    // --- –ù–ê–í–Ü–ì–ê–¶–Ü–Ø –¢–ê –†–ï–ñ–ò–ú–ò ---
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        if(screenId === 'screen-select') loadTaskTypes();
    }

    function setMode(mode) {
        currentMode = mode;
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–Ω–æ–ø–æ–∫
        document.getElementById('mode-auto').className = `btn btn-mode ${mode === 'auto' ? 'active' : ''}`;
        document.getElementById('mode-manual').className = `btn btn-mode ${mode === 'manual' ? 'active' : ''}`;
        
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–∏–¥–∏–º–æ—Å—Ç—ñ –±–ª–æ–∫—ñ–≤
        document.getElementById('auto-container').style.display = mode === 'auto' ? 'block' : 'none';
        document.getElementById('manual-container').style.display = mode === 'manual' ? 'block' : 'none';

        if (mode === 'manual') {
            generateMatrixInputs();
        }
        
        // –û—á–∏—â–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
        document.getElementById('status-box').style.display = 'none';
        document.getElementById('visualizer').style.display = 'none';
        document.getElementById('result-text').innerText = '';
    }

    // --- API: –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –¢–ò–ü–Ü–í ---
    async function loadTaskTypes() {
        const container = document.getElementById('task-buttons-container');
        try {
            const res = await fetch(`${API_BASE}/api/types`);
            const data = await res.json();
            
            container.innerHTML = '';
            if(!data.types || data.types.length === 0) {
                container.innerHTML = '<p>–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –º–æ–¥—É–ª—ñ–≤.</p>';
                return;
            }

            data.types.forEach(type => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary';
                btn.style.minWidth = '250px';
                
                if(type === 'TSP_GENETIC') {
                    btn.innerText = '–ó–∞–¥–∞—á–∞ –ö–æ–º—ñ–≤–æ—è–∂–µ—Ä–∞ (Genetic)';
                    btn.onclick = () => showScreen('screen-tsp');
                } else {
                    btn.innerText = type;
                    btn.onclick = () => alert('–¶–µ–π –º–æ–¥—É–ª—å —â–µ –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ');
                }
                container.appendChild(btn);
            });
        } catch (e) {
            container.innerHTML = '<p style="color:red">–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –∑–∞–ø—É—â–µ–Ω–æ backend.</p>';
        }
    }

    // --- –ú–ê–¢–†–ò–¶–Ø (MANUAL MODE) ---
    function generateMatrixInputs() {
        const count = parseInt(document.getElementById('citiesCount').value);
        if (count < 2) return; 

        const table = document.getElementById('matrixTable');
        table.innerHTML = '';
        
        // Header
        let header = '<tr><th></th>';
        for (let i = 0; i < count; i++) header += `<th>M${i}</th>`;
        header += '</tr>';
        table.innerHTML += header;

        for (let i = 0; i < count; i++) {
            let row = `<tr><th>M${i}</th>`;
            for (let j = 0; j < count; j++) {
                let disabled = (i === j) ? 'disabled' : '';
                let val = (i === j) ? 0 : '';
                row += `<td><input type="number" class="matrix-input" data-r="${i}" data-c="${j}" value="${val}" ${disabled}></td>`;
            }
            row += '</tr>';
            table.innerHTML += row;
        }
    }

    function fillClientRandomMatrix() {
        const inputs = document.querySelectorAll('.matrix-input');
        inputs.forEach(input => {
            if (!input.disabled) input.value = Math.floor(Math.random() * 90) + 10;
        });
    }

    // --- –°–¢–í–û–†–ï–ù–ù–Ø –ó–ê–î–ê–ß–Ü ---
    async function startTask() {
        const count = parseInt(document.getElementById('citiesCount').value);
        let payloadData = {
            cities_count: count,
            generate_random: (currentMode === 'auto') // True, —è–∫—â–æ –ê–≤—Ç–æ
        };

        // –Ø–∫—â–æ —Ä—É—á–Ω–∏–π –≤–≤—ñ–¥, –¥–æ–¥–∞—î–º–æ –º–∞—Ç—Ä–∏—Ü—é
        if (currentMode === 'manual') {
            let matrix = [];
            for (let i = 0; i < count; i++) {
                let row = [];
                for (let j = 0; j < count; j++) {
                    const input = document.querySelector(`.matrix-input[data-r="${i}"][data-c="${j}"]`);
                    let val = parseFloat(input?.value) || 0;
                    row.push(val);
                }
                matrix.push(row);
            }
            payloadData.distance_matrix = matrix;
        }

        try {
            updateStatus('waiting', '–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–¥–∞—á—ñ...');
            
            const response = await fetch(`${API_BASE}/api/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: "TSP_GENETIC",
                    data: payloadData
                })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(JSON.stringify(err.detail));
            }
            
            const resData = await response.json();
            updateStatus('processing', '–ó–∞–¥–∞—á–∞ –≤ —á–µ—Ä–∑—ñ... –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...');
            listenToWebSocket(resData.task_id);

        } catch (e) {
            console.error(e);
            updateStatus('error', '–ü–æ–º–∏–ª–∫–∞: ' + e.message);
        }
    }

    // --- WEBSOCKET ---
    function listenToWebSocket(taskId) {
        const socket = new WebSocket(`${WS_BASE}/ws/${taskId}`);

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            if (data.status === 1) {
                updateStatus('processing', '–û–±—á–∏—Å–ª–µ–Ω–Ω—è –∞–ª–≥–æ—Ä–∏—Ç–º—É...');
            } else if (data.status === 2) {
                socket.close();
                fetchFullResult(taskId); // –ó–∞–±–∏—Ä–∞—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç + –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
            } else if (data.status === 3) {
                updateStatus('error', '–ü–æ–º–∏–ª–∫–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ');
                socket.close();
            }
        };
        
        socket.onclose = () => console.log("WS Closed");
    }

    async function fetchFullResult(taskId) {
        try {
            const res = await fetch(`${API_BASE}/api/result/${taskId}`);
            const fullData = await res.json();
            
            updateStatus('done', '–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!');
            visualize(fullData);

        } catch (e) {
            updateStatus('error', '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç');
        }
    }

    function updateStatus(type, msg) {
        const box = document.getElementById('status-box');
        box.style.display = 'block';
        box.innerText = msg;
        box.className = ''; 
        if(type === 'processing') box.classList.add('status-processing');
        if(type === 'done') box.classList.add('status-done');
        if(type === 'error') box.classList.add('status-error');
    }

    // --- –í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–Ø ---
    function visualize(fullData) {
        const result = fullData.result;
        const input = fullData.input_data;
        const canvas = document.getElementById('visualizer');
        canvas.style.display = 'block';
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        ctx.clearRect(0, 0, w, h);

        // –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
        const route = result.route || result.path || [];
        const dist = result.distance || result.min_distance || 0;

        document.getElementById('result-text').innerHTML = `
            <strong>–ú–∞—Ä—à—Ä—É—Ç:</strong> ${route.join(' ‚ûù ')} <br>
            <strong>–ó–∞–≥–∞–ª—å–Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å:</strong> ${parseFloat(dist).toFixed(2)}
        `;

        // –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —Ç–æ—á–æ–∫
        let nodes = [];
        
        // –°–¶–ï–ù–ê–†–Ü–ô –ê: –Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä –∑–≥–µ–Ω–µ—Ä—É–≤–∞–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ (generate_random=True)
        if (input.coordinates && input.coordinates.length > 0) {
            const padding = 40;
            // –ú–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞ 0..100 -> canvas width/height
            const scaleX = (w - padding * 2) / 100;
            const scaleY = (h - padding * 2) / 100;

            nodes = input.coordinates.map((pt, idx) => ({
                id: idx,
                x: padding + pt.x * scaleX,
                y: padding + pt.y * scaleY
            }));
        } 
        // –°–¶–ï–ù–ê–†–Ü–ô –ë: –†—É—á–Ω–∏–π –≤–≤—ñ–¥ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–µ–º–∞—î, –º–∞–ª—é—î–º–æ –ø–æ –∫–æ–ª—É)
        else {
            const count = input.cities_count;
            const centerX = w / 2;
            const centerY = h / 2;
            const radius = Math.min(w, h) / 2 - 50;
            
            for (let i = 0; i < count; i++) {
                const angle = (i / count) * 2 * Math.PI - Math.PI / 2;
                nodes.push({
                    id: i,
                    x: centerX + radius * Math.cos(angle),
                    y: centerY + radius * Math.sin(angle)
                });
            }
        }

        // 1. –ú–∞–ª—é—î–º–æ –ª—ñ–Ω—ñ—ó
        if (route.length > 0) {
            ctx.beginPath();
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 2;
            
            for (let i = 0; i < route.length - 1; i++) {
                const n1 = nodes[route[i]];
                const n2 = nodes[route[i+1]];
                if(n1 && n2) {
                    ctx.moveTo(n1.x, n1.y);
                    ctx.lineTo(n2.x, n2.y);
                }
            }
            // –ó–∞–º–∏–∫–∞–Ω–Ω—è
            const start = nodes[route[0]];
            const end = nodes[route[route.length-1]];
            if (start && end && route[0] !== route[route.length-1]) {
                 ctx.moveTo(end.x, end.y);
                 ctx.lineTo(start.x, start.y);
            }
            ctx.stroke();
        }

        // 2. –ú–∞–ª—é—î–º–æ —Ç–æ—á–∫–∏
        nodes.forEach(node => {
            ctx.beginPath();
            ctx.arc(node.x, node.y, 15, 0, 2 * Math.PI);
            ctx.fillStyle = '#3498db';
            ctx.fill();
            ctx.strokeStyle = '#2c3e50';
            ctx.stroke();

            ctx.fillStyle = 'white';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(node.id, node.x, node.y);
        });
    }
</script>

</body>
</html>